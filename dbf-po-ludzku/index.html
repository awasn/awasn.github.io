<!DOCTYPE HTML>
<html lang="pl-pl">
    <head>
        <meta name="theme-color" content="#405365"/>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="generator" content="Hugo 0.83.1" />
        <meta name="description" content="Obsługa operacji odczytu i zapisu plików DBF w .NET C#" />
        <title>DBF po ludzku - arkadiusz wasniewski blog</title>
        <link rel="canonical" href="https://awasn.github.io/dbf-po-ludzku/">
        <link rel="prev" title="Wyjątki" href="https://awasn.github.io/wyjatki/">
        <link rel="next" title="Herr Mock i Frau Command" href="https://awasn.github.io/herr-mock-i-frau-command/">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css" integrity="sha256-Q0zCrUs2IfXWYx0uMKJfG93CvF6oVII21waYsAV4/8Q=" crossorigin="anonymous" />
        
        
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css" integrity="sha256-YqnnS/cQ7vE7gfVjdfx+JMi5EFD6m6Zqdemj81rs6PU=" crossorigin="anonymous" />
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/styles/agate.min.css">
        <link rel="stylesheet" href="https://awasn.github.io/awasn.min.f45a909800924faa836a73b82a1d4cb352f8053134a426a9dcafa61cf6a8c5d0.css" integrity="sha256-9FqQmACST6qDanO4Kh1Ms1L4BTE0pCap3K&#43;mHPaoxdA=" />

    </head>
    <body>
        <header>
            <nav class="container" >
                <div class="pure-menu pure-menu-horizontal">
                    <a class="pure-menu-heading pure-menu-link" href="https://awasn.github.io/">wasniewski</a>
                    <ul class="right pure-menu-list">
                        <li class="pure-menu-item"><a class="pure-menu-link" href="https://awasn.github.io/blog/">blog</a></li>
                        <li class="pure-menu-item"><a class="pure-menu-link" href="https://awasn.github.io/categories/">categories</a></li>
                        <li class="pure-menu-item"><a class="pure-menu-link" href="https://awasn.github.io/tags/">tags</a></li>
                        <li class="pure-menu-item"><a class="pure-menu-link" href="https://awasn.github.io/about/">about</a></li>
                    </ul>
                </div>
            </nav>
        </header>

        <main class="container">
            
    <aside class="post-published">
        <p>This post was originally published on <a href="http://zine.net.pl/blogs/arkadiusz_wasniewski/archive/2007/06/12/dbf-po-ludzku.aspx" target="_blank">zine.net.pl</a> on 12 June 2007 15:02 &#43;0200</p>
    </aside>

    <article>
        <header>
            <h1>DBF po ludzku</h1>
                <div class="post-metadata">
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            12 June 2007 15:02 &#43;0200
            
            &nbsp;
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            4 min read
        </div>
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
            <a href="https://awasn.github.io/categories/development">Development</a>, <a href="https://awasn.github.io/categories/databases">Databases</a>
            
                &nbsp;
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>
                <a href="https://awasn.github.io/tags/.net">.NET</a>, <a href="https://awasn.github.io/tags/interop">Interop</a>
            
        </div>
    </div>
        </header>

        <p>Jakiś czas temu Sławek <a href="http://zine.net.pl/blogs/ucel/archive/2007/05/14/Dost_1901_p-do-danych-Excela-za-pomoc_0501_-ODBC.aspx">pisał</a> o dostępie poprzez sterowniki ODBC do tabel w formacie Excel. W podobny sposób można również próbować przetwarzać pliki DBF. Ale można też prościej&hellip; bardziej po ludzku&hellip;</p>
<p>Wersji formatu DBF jest oczywiście wiele, ale my zajmiemy się wersją 3, bardzo popularną zwłaszcza w środowisku MS-DOS. Niezbędne będzie przy tym skorzystanie z przestrzeni nazw <code>InteropServices</code> umożliwiającej dostęp do kodu niezarządzanego.</p>
<p>Każdy plik DBF składa się z nagłówka</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a6e22e">    [StructLayout(LayoutKind.Sequential)]</span>
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Dbf3Header</span>
    {
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">byte</span> ReservedSize = <span style="color:#ae81ff">20</span>;

        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span> Dbf;
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span> Year;
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span> Mounth;
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span> Day;
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> RecordCount;
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">ushort</span> HeaderSize;
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">ushort</span> RecordSize;
<span style="color:#a6e22e">        [MarshalAs(UnmanagedType.ByValArray, SizeConst=Dbf3Header.ReservedSize)]</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span>[] Reserved;
    }
</code></pre></div><p>który zawiera podstawowe informacje o przechowywanych wewnątrz danych. Nazwy pól są na tyle dosłowne, iż nie będziemy się na ich temat rozwodzić. Każde pole, które będzie występować w pliku, opisane jest w następujący sposób:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a6e22e">    [StructLayout(LayoutKind.Sequential)]</span>
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Dbf3Field</span>
    {
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">byte</span> FieldNameSize = <span style="color:#ae81ff">11</span>;
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">byte</span> ReservedSize = <span style="color:#ae81ff">14</span>;
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [MarshalAs(UnmanagedType.ByValArray, SizeConst=Dbf3Field.FieldNameSize)]</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span>[] FieldName;
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span> FieldType;
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Offset;
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span> Length;
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span> Precision;
<span style="color:#a6e22e">        [MarshalAs(UnmanagedType.ByValArray, SizeConst=Dbf3Field.ReservedSize)]</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span>[] Reserved;
    }
</code></pre></div><p>Pole <code>FieldType</code> zawiera rodzaj pola i może przyjmować wartość (w wersji tej dla uproszczenia pominiemy pola typu memo):</p>
<ul>
<li><code>C</code> dla pola znakowego;</li>
<li><code>D</code> dla pola data;</li>
<li><code>L</code> dla pola logicznego;</li>
<li><code>N</code> dla pola numerycznego.</li>
</ul>
<p>Aby móc wykonywać operacje na pliku DBF musimy go wpierw otworzyć:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> OpenDbf()
        {
            header = MarshalHelper.FromStream&lt;Dbf3Header&gt;(<span style="color:#66d9ef">this</span>.stream);
            <span style="color:#66d9ef">int</span> fieldCount =
                (header.HeaderSize - Marshal.SizeOf(header)) /
                Marshal.SizeOf(<span style="color:#66d9ef">typeof</span>(Dbf3Field));

            fields = <span style="color:#66d9ef">new</span> Dictionary&lt;<span style="color:#66d9ef">string</span>, Dbf3Field&gt;(fieldCount);
            <span style="color:#66d9ef">int</span> offset = <span style="color:#ae81ff">1</span>;
            <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; fieldCount; i++)
            {
                Dbf3Field field = MarshalHelper.FromStream&lt;Dbf3Field&gt;(
                    <span style="color:#66d9ef">this</span>.stream);
                field.Offset = offset;
                offset = offset + field.Length;
                fields.Add(MarshalHelper.ByteArrayToString(
                    field.FieldName).ToUpper(), field);
            }

            buffer = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[header.RecordSize];
        }
</code></pre></div><p>lub utworzyć:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> CreateDbf()
        {
            header.Dbf = <span style="color:#ae81ff">0x03</span>;
            header.RecordCount = <span style="color:#ae81ff">0</span>;
            header.RecordSize = <span style="color:#ae81ff">0</span>;
            header.HeaderSize = (<span style="color:#66d9ef">ushort</span>)(Marshal.SizeOf(header) + <span style="color:#ae81ff">1</span>);

            MarshalHelper.ToStream&lt;Dbf3Header&gt;(stream, header);
            <span style="color:#66d9ef">this</span>.WriteToStreamEndOfHeader();

            fields = <span style="color:#66d9ef">new</span> Dictionary&lt;<span style="color:#66d9ef">string</span>, Dbf3Field&gt;();
        }
</code></pre></div><p>Jeśli plik został przez nas utworzony to powinniśmy dodać do niego definicje pól, które będą wewnątrz składowane (w poniższym przykładzie dla uproszczenia pominięto wszystkie pola poza rodzajem data):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> NewField(<span style="color:#66d9ef">string</span> fieldName, Dbf3FieldType fieldType,
            <span style="color:#66d9ef">byte</span> length, <span style="color:#66d9ef">byte</span> precision)
        {
            Dbf3Field field = <span style="color:#66d9ef">new</span> Dbf3Field();

            field.FieldName = MarshalHelper.StringToByteArray(
                fieldName.ToUpper(), Dbf3Field.FieldNameSize);
            <span style="color:#66d9ef">switch</span> (fieldType)
            {
                ...
                <span style="color:#66d9ef">case</span> Dbf3FieldType.Date:
                    field.FieldType = Convert.ToByte(<span style="color:#e6db74">&#39;D&#39;</span>);
                    field.Length = <span style="color:#ae81ff">8</span>;
                    field.Precision = <span style="color:#ae81ff">0</span>;
                    <span style="color:#66d9ef">break</span>;
                ...
            }

            <span style="color:#66d9ef">if</span> (header.RecordSize == <span style="color:#ae81ff">0</span>)
                header.RecordSize = <span style="color:#ae81ff">1</span>;
            field.Offset = header.RecordSize;
            header.HeaderSize += (<span style="color:#66d9ef">ushort</span>)Marshal.SizeOf(<span style="color:#66d9ef">typeof</span>(Dbf3Field));
            header.RecordSize += field.Length;

            fields.Add(fieldName.ToUpper(), field);
        }
</code></pre></div><p>Mając przygotowany plik DBF możemy dodawać do niego nowe wiersze. Wpierw przygotowujemy bufor dla danych:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> NewRecord()
        {
            buffer = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[header.RecordSize];
        }
</code></pre></div><p>a po wypełnieniu zapisujemy na dysk:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Write()
        {
            stream.Position = header.HeaderSize +
                header.RecordSize * header.RecordCount;
            header.RecordCount++;
            stream.Write(buffer, <span style="color:#ae81ff">0</span>, buffer.Length);
        }
</code></pre></div><p>Wszystkie dane w plikach DBF są składowane w postaci łańcuchów. Oznacza to, iż tak naprawdę potrzebujemy jednej głównej metody do zapisu danych:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> SetString(<span style="color:#66d9ef">string</span> fieldName, <span style="color:#66d9ef">string</span> <span style="color:#66d9ef">value</span>)
        {
            Dbf3Field field = <span style="color:#66d9ef">this</span>.GetField(fieldName);
            <span style="color:#66d9ef">string</span> fieldValue;
            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">value</span> == <span style="color:#66d9ef">null</span>)
                <span style="color:#66d9ef">value</span> = <span style="color:#66d9ef">string</span>.Empty;
            <span style="color:#66d9ef">if</span> (field.FieldType == Convert.ToByte(<span style="color:#e6db74">&#39;C&#39;</span>))
                fieldValue = <span style="color:#66d9ef">value</span>.PadRight(field.Length);
            <span style="color:#66d9ef">else</span>
                fieldValue = <span style="color:#66d9ef">value</span>.PadLeft(field.Length);
            <span style="color:#66d9ef">byte</span>[] data = Encoding.Default.GetBytes(fieldValue);
            Buffer.BlockCopy(data, <span style="color:#ae81ff">0</span>, buffer, field.Offset, field.Length);
        }
</code></pre></div><p>Reszta metod umożliwiających zapisywanie innych typów danych wywołuje wewnętrznie tę metodę wykonując rzutowanie na typ łańcuchowy np.:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> SetInt32(<span style="color:#66d9ef">string</span> fieldName, <span style="color:#66d9ef">int</span> <span style="color:#66d9ef">value</span>)
        {
            <span style="color:#66d9ef">this</span>.SetString(fieldName, Convert.ToString(
                <span style="color:#66d9ef">value</span>, dbfCultureInfo));
        }
</code></pre></div><p>Przy konwersji musimy zwrócić uwagę na fakt, iż dane w pliku DBF są składowane według amerykańskich ustawień regionalnych. To samo dotyczy danych odczytywanych:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> GetInt32(<span style="color:#66d9ef">string</span> fieldName)
        {
            <span style="color:#66d9ef">return</span> Convert.ToInt32(<span style="color:#66d9ef">this</span>.GetString(fieldName),
                dbfCultureInfo);
        }
</code></pre></div><p>Operując na plikach DBF należy również pamiętać, iż po nagłówku należy w strumieniu umieścić znacznik końca nagłówka <code>0x0D</code>, a po zapisaniu wszystkich danych na dysk znacznik końca danych <code>0x1A</code>.</p>
<p>Powyższe przykłady zawierają między innymi wywołania metod pomocniczej klasy <code>MarshalHelper</code>. Klasa ta definiuje metody ułatwiające zamianę kodu zarządzanego na niezarządzany i odwrotnie. Korzysta ona przede wszystkim z <code>Marshal.StructureToPtr</code> oraz z <code>Marshal.PtrToStructure</code>.</p>
<p>Dzięki powyższemu kodowi możemy uniezależnić się od sterowników i ustawień systemowych co niejednokrotnie bardzo się przydaje, jeśli oczywiście ktoś z tego typu rozwiązań musi korzystać.</p>
<hr>
<ul>
<li>Klasa <code>MarshalHelper</code> dostępna jest (wraz z opisem) we wpisie z czerwca 2008 roku: <a href="https://awasn.github.io/marshalhelper-zarzadza-niezarzadzanym/">MarshalHelper zarządza niezarządzanym</a></li>
</ul>

    </article>
    <nav aria-label="Related posts">
        <h4>Related Posts</h4>
        <ul>
            <li><a href="https://awasn.github.io/wyjatki/">Wyjątki</a></li>
            <li><a href="https://awasn.github.io/liczby-calkowite/">Liczby całkowite</a></li>
            <li><a href="https://awasn.github.io/t4-lepsze-niz-t34/">T4 lepsze niż T34</a></li>
        </ul>
    </nav>

    <nav class="pure-g post-previous-next" aria-label="Previous and next posts">
        <div class="pure-u-11-24 previous">
            <a href="https://awasn.github.io/wyjatki/" aria-label="Previous post"><span aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-left"><polyline points="15 18 9 12 15 6"></polyline></svg></span></a>
            <a href="https://awasn.github.io/wyjatki/">Wyjątki</a>
        </div>
        <div class="pure-u-2-24">&nbsp;</div>
        <div class="pure-u-11-24 next">
            <a href="https://awasn.github.io/herr-mock-i-frau-command/">Herr Mock i Frau Command</a>
            <a href="https://awasn.github.io/herr-mock-i-frau-command/" aria-label="Next post"><span aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline></svg></span></a>
        </div>
    </nav>

    


        </main>

        <footer>
            <div class="center-aligned container">
                <p>Copyright &copy; 2007-2021 Arkadiusz Waśniewski. All Rights Reserved.</p>
            </div>
        </footer>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/accesslog.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/dockerfile.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/dos.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/go.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/powershell.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/routeros.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/typescript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/vbnet.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>