<!doctype html><html lang=pl-pl><head><meta name=theme-color content="#405365"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><meta name=description content="Czyszczenie pamięci podręcznej programu Pocket Internet Explorer aby zwolnić zajęte przez klasy MFC zasoby"><title>Mobilne MFC a protokół HTTP - arkadiusz wasniewski blog</title><link rel=canonical href=https://awasn.github.io/mobilne-mfc-a-protokol-http/><link rel=prev title="Zadzwoń sam do siebie" href=https://awasn.github.io/zadzwon-sam-do-siebie/><link rel=next title="Z Virtual PC do VMware Server" href=https://awasn.github.io/z-virtual-pc-do-vmware-server/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css integrity="sha256-Q0zCrUs2IfXWYx0uMKJfG93CvF6oVII21waYsAV4/8Q=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css integrity="sha256-YqnnS/cQ7vE7gfVjdfx+JMi5EFD6m6Zqdemj81rs6PU=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/styles/agate.min.css><link rel=stylesheet href=https://awasn.github.io/awasn.min.f45a909800924faa836a73b82a1d4cb352f8053134a426a9dcafa61cf6a8c5d0.css integrity="sha256-9FqQmACST6qDanO4Kh1Ms1L4BTE0pCap3K+mHPaoxdA="></head><body><header><nav class=container><div class="pure-menu pure-menu-horizontal"><a class="pure-menu-heading pure-menu-link" href=https://awasn.github.io/>wasniewski</a><ul class="right pure-menu-list"><li class=pure-menu-item><a class=pure-menu-link href=https://awasn.github.io/blog/>blog</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://awasn.github.io/categories/>categories</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://awasn.github.io/tags/>tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://awasn.github.io/about/>about</a></li></ul></div></nav></header><main class=container><aside class=post-published><p>This post was originally published on <a href=http://zine.net.pl/blogs/arkadiusz_wasniewski/archive/2007/08/31/mobilne-mfc-a-protok-http.aspx target=_blank>zine.net.pl</a> on 31 August 2007 10:37 +0200</p></aside><article><header><h1>Mobilne MFC a protokół HTTP</h1><div class=post-metadata><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>31 August 2007 10:37 +0200
&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
2 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><a href=https://awasn.github.io/categories/development>Development</a>
&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<a href=https://awasn.github.io/tags/mobile>Mobile</a>, <a href=https://awasn.github.io/tags/c/c++>C/C++</a></div></div></header><p>Wakacje nie wakacje, szukanie pracy czy nie, wypadałoby zadbać o swój blog. Dzisiaj trochę z innej beczki (chociaż jak się zastanowić to nie znajduję argumentów czemu z innej niby beczki) ale wciąż w temacie mobilnym. Po to aby nie zapomnieć.</p><p>Osoby programujące urządzenia mobilne i korzystające z klas MFC w ramach Microsoft eMbedded Visual C++ i chcące do wymiany danych wykorzystać protokół HTTP natkną się na niemiłą niespodziankę. Każda odebrana odpowiedź z serwera zmniejsza nam ilość dostępnej pamięci na dysku. Jeśli pobierzemy z sieci plik i zapiszemy go na dysku, wolna przestrzeń zostanie zmniejszona dwukrotnie biorąc pod uwagę rozmiar pliku. Ki diabeł?</p><p>Problem polega na tym, iż MFC (między innymi klasy <code>CInternetSession</code>, <code>CHttpFile</code>) do obsługi protokołu HTTP wykorzystuje zasoby programu Pocket Internet Explorer, który odebrane dane przechowuje w pamięci podręcznej. Sprawdzić to można wizualnie w katalogu <strong>Windows\Profiles\guest\Temporary Internet Files\Content.IE5</strong>. Oczywiście możemy z poziomu tego programu zwolnić zajęte zasoby, ale taka filozofia jest mi z gruntu obca ideowo. Jak inaczej do tego podejść?</p><p>W ramach wersji systemu Pocket PC 2002 i na części urządzeń wykorzystujących Pocket PC 2003 pewnym rozwiązaniem były odpowiednie wpisy w rejestrach (gałąź <strong>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\InternetSettings</strong> i podgałęzie <strong>Cache</strong> lub <strong>5.0\Cache</strong> w zależności od wersji systemu). Ale w większości urządzeń sposób ten nie sprawdzał się. Zasobów ubywało.</p><p>Obie klasy, to znaczy <code>CInternetSession</code> w ramach konstruktora jak i <code>CHttpFile</code> w metodzie <code>OpenRequest</code>, mogą przyjmować jako jeden ze swoich parametrów flagę <code>INTERNET_FLAG_DONT_CACHE</code>. Wspaniale, tylko, co jest w dokumentacji środowiska Microsoft eMbedded Visual C++ wyraźnie napisane, flaga ta nie jest dozwolona w MFC na urządzenia mobilne.</p><p>W Microsoft Visual Studio 2005, w której to wersji pojawiła się wreszcie możliwość korzystania z języka C++ przy programowaniu urządzeń mobilnych, biblioteka MFC, dostępna w wersji 8.0, została pozbawiona wymienionych wcześniej klas. Co może dziwić. Na szczęście zanim człowiek się zorientował (refleks szachisty) wraz z Sevice Pack 1, klasy te zostały przywrócone. Ponieważ w dokumentacji nie było żadnych informacji o ograniczeniach dotyczących parametrów przyjmowanych przez metody (a szkoda), stworzyłem prościutką aplikację, która miała potwierdzić kiełkującą w głowie radość. Niestety brutalna rzeczywistość makra <code>ASSERT</code> w warunkach zmiennej warunkowej kompilacji <code>_WIN32_WCE</code> rozwiała wszelkie nadzieje.</p><p>Co zatem więc? Otóż okazuje się, iż rozwiązanie tego problemu jest w zasięgu naszych możliwości programistycznych. Wystarczy skorzystać z dobrodziejstw metod <code>FindFirstUrlCacheEntry</code>, <code>FindNextUrlCacheEntry</code>, <code>FindCloseUrlCache</code> oraz <code>DeleteUrlCacheEntry</code>, które umożliwiają nam iterację po elementach pamięci podręcznej (szukamy <code>COOKIE_CACHE_ENTRY</code>) oraz usunięcie niepotrzebnych danych. Tyle i aż tyle.</p><p>Na pocieszenie zostaje fakt, iż C# w ramach platformy .NET Compact Framework takich ograniczeń nie posiada i możemy z protokołu HTTP korzystać dowoli bez obaw, iż znienacka zabraknie nam zasobów.</p></article><nav aria-label="Related posts"><h4>Related Posts</h4><ul><li><a href=https://awasn.github.io/dobre-praktyki-w-projektowaniu-aplikacji-mobilnych/>Dobre praktyki w projektowaniu aplikacji mobilnych</a></li></ul></nav><nav class="pure-g post-previous-next" aria-label="Previous and next posts"><div class="pure-u-11-24 previous"><a href=https://awasn.github.io/zadzwon-sam-do-siebie/ aria-label="Previous post"><span aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-left"><polyline points="15 18 9 12 15 6"/></svg></span></a><a href=https://awasn.github.io/zadzwon-sam-do-siebie/>Zadzwoń sam do siebie</a></div><div class=pure-u-2-24>&nbsp;</div><div class="pure-u-11-24 next"><a href=https://awasn.github.io/z-virtual-pc-do-vmware-server/>Z Virtual PC do VMware Server</a>
<a href=https://awasn.github.io/z-virtual-pc-do-vmware-server/ aria-label="Next post"><span aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"/></svg></span></a></div></nav></main><footer><div class="center-aligned container"><p>Copyright &copy; 2007-2021 Arkadiusz Waśniewski. All Rights Reserved.</p></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/accesslog.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/dockerfile.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/dos.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/powershell.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/routeros.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/yaml.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/vbnet.min.js></script><script>hljs.initHighlightingOnLoad()</script></body></html>