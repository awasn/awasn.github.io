<!DOCTYPE HTML>
<html lang="pl-pl">
    <head>
        <meta name="theme-color" content="#405365"/>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="generator" content="Hugo 0.54.0" />
        <meta name="description" content="Kod niezarządzany w .NET C# do operacji odczytu i zapisu plików DBF" />
        <title>MarshalHelper zarządza niezarządzanym - arkadiusz wasniewski blog</title>
        <link rel="canonical" href="https://awasn.github.io/marshalhelper-zarzadza-niezarzadzanym/">
        <link rel="prev" title="Debugger.Break ładuje pakiety" href="https://awasn.github.io/debugger-break-laduje-pakiety/">
        <link rel="next" title="Range&lt;T&gt;" href="https://awasn.github.io/range-t/">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css" integrity="sha256-Q0zCrUs2IfXWYx0uMKJfG93CvF6oVII21waYsAV4/8Q=" crossorigin="anonymous" />
        
        
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css" integrity="sha256-YqnnS/cQ7vE7gfVjdfx+JMi5EFD6m6Zqdemj81rs6PU=" crossorigin="anonymous" />
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/styles/agate.min.css">
        <link rel="stylesheet" href="https://awasn.github.io/awasn.min.809247dcc0227e384b256fd9df3f1c82b2b752f0ca6ba0f97410d05bcdd60729.css" integrity="sha256-gJJH3MAifjhLJW/Z3z8cgrK3UvDKa6D5dBDQW83WByk=" />

    </head>
    <body>
        <header>
            <nav class="container" >
                <div class="pure-menu pure-menu-horizontal">
                    <a class="pure-menu-heading pure-menu-link" href="https://awasn.github.io/">wasniewski</a>
                    <ul class="right pure-menu-list">
                        <li class="pure-menu-item"><a class="pure-menu-link" href="https://awasn.github.io/blog/">blog</a></li>
                        <li class="pure-menu-item"><a class="pure-menu-link" href="https://awasn.github.io/categories/">categories</a></li>
                        <li class="pure-menu-item"><a class="pure-menu-link" href="https://awasn.github.io/tags/">tags</a></li>
                        <li class="pure-menu-item"><a class="pure-menu-link" href="https://awasn.github.io/about/">about</a></li>
                    </ul>
                </div>
            </nav>
        </header>

        <main class="container">
            
    <aside class="post-published">
        <p>This post was originally published on <a href="http://zine.net.pl/blogs/arkadiusz_wasniewski/archive/2008/06/04/marshalhelper-zarz-dza-niezarz-dzanym.aspx" target="_blank">zine.net.pl</a> on 4 June 2008 14:01 CEST</p>
    </aside>

    <article>
        <header>
            <h1>MarshalHelper zarządza niezarządzanym</h1>
                <div class="post-metadata">
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            04 June 2008 14:01 CEST
            
            &nbsp;
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            2 min read
        </div>
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
            <a href="https://awasn.github.io/categories/development">Development</a>
            
                &nbsp;
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>
                <a href="https://awasn.github.io/tags/.net">.NET</a>, <a href="https://awasn.github.io/tags/interop">Interop</a>
            
        </div>
    </div>
        </header>

        <p>W notce dotyczącej <a href="https://awasn.github.io/iteratory/" target="_blank">iteratorów</a> czy też kiedy opisywałem operacje na plikach <a href="https://awasn.github.io/dbf-po-ludzku/" target="_blank">DBF</a> posługiwałem się klasą pomocniczą <code>MarshalHelper</code>, która wykonywała wszystkie niezbędne czynności przy konwersji typów z kodu zarządzanego do niezarządzanego i vice versa. Wykorzystanie klas przestrzeni <code>System.Runtime.InteropServices</code> było konieczne, ponieważ w kodzie zarządzanym nie mamy gwarancji, iż pola z danej struktury będą w pamięci ułożone w tej samej kolejności i wyrównane powiedzmy do 8 bajtów.</p>

<p>Sama implementacja metod pomocniczych klasy nie jest skomplikowana. W sieci można znaleźć trochę pomysłów. Poniżej kod całej klasy:</p>

<pre><code class="language-csharp">    internal static class MarshalHelper
    {
        public static Encoding encoding = Encoding.GetEncoding(852);

        /// &lt;summary&gt;
        /// Zapisanie struktury w pamięci do tablicy bajtów.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;structure&quot;&gt;Struktura lub klasa, którą chcemy
        /// zapisać.&lt;/param&gt;
        /// &lt;returns&gt;Strumień bajtów zawierający strukturę danych.&lt;/returns&gt;
        public static byte[] ToByteArray&lt;T&gt;(T structure)
        {
            byte[] buffer = new byte[Marshal.SizeOf(structure)];
            GCHandle handle = GCHandle.Alloc(buffer, GCHandleType.Pinned);
            Marshal.StructureToPtr(structure, handle.AddrOfPinnedObject(), false);
            handle.Free();
            return buffer;
        }

        /// &lt;summary&gt;
        /// Zapianie łańcucha znaków do tablicy bajtów z uwzględnieniem
        /// kodowania (zmiany strony kodowej).
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;field&quot;&gt;Łańcuch, który będziemy zapisywać.&lt;/param&gt;
        /// &lt;param name=&quot;fieldLength&quot;&gt;Liczba bajtów tablicy.&lt;/param&gt;
        /// &lt;returns&gt;Tablica bajtów zawierająca łańcuch po operacji
        /// zmiany strony kodowej.&lt;/returns&gt;
        public static byte[] StringToByteArray(string field, int fieldLength)
        {
            Debug.Assert(fieldLength &gt; 0);

            if(field == null){
                field = string.Empty;
            }
            byte[] source = encoding.GetBytes(field);
            byte[] destination = new byte[fieldLength];
            Debug.Assert(source.Length &lt;= fieldLength);
            Array.Copy(source, destination, source.Length);
            return destination;
        }

        /// &lt;summary&gt;
        /// Zapisanie tablicy znaków jako łańcucha znaków z uwzględnieniem zmiany
        /// strony kodowej.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;field&quot;&gt;Tablica znaków, którą będziemy zapisywać.&lt;/param&gt;
        /// &lt;returns&gt;Łańcuch zawierający tablicę znaków z uwzględnieniem
        /// zmiany strony kodowej.&lt;/returns&gt;
        public static string ByteArrayToString(byte[] field)
        {
            string s = encoding.GetString(field, 0, field.Length);
            int index = s.IndexOf('\0');
            return index &gt; 0 ? s.Remove(index, s.Length - index) : s;
        }

        /// &lt;summary&gt;
        /// Odczytanie struktury ze strumienia.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;Typ struktury.&lt;/typeparam&gt;
        /// &lt;param name=&quot;stream&quot;&gt;Strumień, z którego czytamy.&lt;/param&gt;
        /// &lt;returns&gt;Zwracana struktura.&lt;/returns&gt;
        public static T FromStream&lt;T&gt;(Stream stream)
        {
            Debug.Assert(stream != null);

            byte[] buffer = new byte[Marshal.SizeOf(typeof(T))];
            int bytesRead = stream.Read(buffer, 0, buffer.Length);
            if(bytesRead == 0){
                return default(T);
            }
            if(bytesRead != buffer.Length){
                throw new EndOfStreamException(
                    string.Format(
                        &quot;Rozmiar bufora: {0}. Liczba bajtów odczytanych: {1}.&quot;,
                        buffer.Length, bytesRead));
            }
            GCHandle handle = GCHandle.Alloc(buffer, GCHandleType.Pinned);
            T structure = (T) Marshal.PtrToStructure(handle.AddrOfPinnedObject(), typeof(T));
            handle.Free();
            return structure;
        }

        /// &lt;summary&gt;
        /// Zapisanie struktury do strumienia.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;Typ struktury.&lt;/typeparam&gt;
        /// &lt;param name=&quot;stream&quot;&gt;Strumień, do którego zapisujemy.&lt;/param&gt;
        /// &lt;param name=&quot;structure&quot;&gt;Zapisywana struktura&lt;/param&gt;
        public static void ToStream&lt;T&gt;(Stream stream, T structure)
        {
            Debug.Assert(stream != null);

            byte[] buffer = ToByteArray(structure);
            stream.Write(buffer, 0, buffer.Length);
        }
    }
</code></pre>

<p>Życzę miłej zabawy.</p>

    </article>
    <nav aria-label="Related posts">
        <h4>Related Posts</h4>
        <ul>
            <li><a href="https://awasn.github.io/iteratory/">Iteratory</a></li>
            <li><a href="https://awasn.github.io/dbf-po-ludzku/">DBF po ludzku</a></li>
            <li><a href="https://awasn.github.io/nie-wyrzucamy-wyjatkow-poza-domain-model/">Nie wyrzucamy wyjątków poza Domain Model</a></li>
            <li><a href="https://awasn.github.io/hook-scripts-w-csharp/">Hook scripts w C#</a></li>
            <li><a href="https://awasn.github.io/http-wlasny-serwer-komunikacji-cz2-srodowisko-programistyczne/">HTTP - Własny serwer komunikacji. Część #2 - Środowisko programistyczne</a></li>
        </ul>
    </nav>

    <nav class="pure-g post-previous-next" aria-label="Previous and next posts">
        <div class="pure-u-11-24 previous">
            <a href="https://awasn.github.io/debugger-break-laduje-pakiety/" aria-label="Previous post"><span aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-left"><polyline points="15 18 9 12 15 6"></polyline></svg></span></a>
            <a href="https://awasn.github.io/debugger-break-laduje-pakiety/">Debugger.Break ładuje pakiety</a>
        </div>
        <div class="pure-u-2-24">&nbsp;</div>
        <div class="pure-u-11-24 next">
            <a href="https://awasn.github.io/range-t/">Range&lt;T&gt;</a>
            <a href="https://awasn.github.io/range-t/" aria-label="Next post"><span aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline></svg></span></a>
        </div>
    </nav>

    


        </main>

        <footer>
            <div class="center-aligned container">
                <p>Copyright &copy; 2007-2019 Arkadiusz Waśniewski. All Rights Reserved.</p>
            </div>
        </footer>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/accesslog.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/dockerfile.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/dos.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/go.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/powershell.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/routeros.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/typescript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/vbnet.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>